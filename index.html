<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calcolo Totale Sostanze</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin: 8px 0;
      color: #555;
    }

    input,
    textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      background-color: #e5e7eb;
      transition: 0.15s ease;
    }

    button:hover {
      background-color: #d4d4d8;
    }

    #subtitle {
      font-size: 0.9em;
      color: #555;
      background-color: #eef1f5;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      margin-top: 20px;
      margin-bottom: 20px;
      line-height: 1.4;
      text-align: center;
      font-family: "Arial", sans-serif;
    }

    #addButton {
      background-color: #4caf50;
      color: white;
    }

    #deleteButton {
      background-color: red;
      color: white;
    }

    #result {
      margin-top: 20px;
      padding: 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .famiglia {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 10px;
    }

    .dettagli,
    .sanzione,
    .totale-netto {
      margin: 10px 0;
    }

    hr {
      margin: 10px 0;
      border: 0;
      border-top: 1px solid #ddd;
    }

    .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }

    .chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background-color: #e0e7ff;
      font-size: 0.8rem;
      cursor: pointer;
      border: 1px solid #c7d2fe;
      user-select: none;
    }

    .chip:hover {
      background-color: #c7d2fe;
    }

    #exportButtons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    #exportButtons button {
      background-color: #3b82f6;
      color: white;
    }

    #priceManager {
      margin-top: 25px;
      padding: 15px;
      background-color: #f3f4f6;
      border-radius: 8px;
    }

    .price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .price-row label {
      margin: 0;
      font-size: 0.9rem;
    }

    .price-row input {
      width: 120px;
    }

    #savePricesButton {
      background-color: #10b981;
      color: white;
      margin-top: 10px;
    }

    .note-prezzo {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 5px;
    }

    .warning-prezzo {
      color: #b91c1c;
      font-size: 0.85rem;
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <strong><code>Alias:</strong>  Puoi usare degli alias per i tipi di droga : </code>
      <ul>
        <li><code>"coca" per "cocaina"</code></li>
        <li><code>"keta" per "ketamina"</code></li>
        <li><code>"acido / francobolli" per "lsd"</code></li>
        <li><code>"maria / erba" per "marijuana"</code></li>
        <li><code>fenicillina</code></li>
      </ul>

      <h1>Calcolatore di Totale Sostanze</h1>

      <!-- Form di inserimento sostanze -->
      <label for="famiglia">Nome Famiglia:</label>
      <input type="text" id="famiglia" placeholder="Inserisci il nome della famiglia" />

      <label for="sostanze">
        Sostanze e Quantit√† (es: 600 cocaina, 1000 eroina):
      </label>
      <input type="text" id="sostanze" placeholder="Inserisci sostanze e quantit√†" />
      <div class="chips-container">
        <span class="chip" onclick="aggiungiDroga('cocaina','sostanze')">cocaina</span>
        <span class="chip" onclick="aggiungiDroga('ketamina','sostanze')">ketamina</span>
        <span class="chip" onclick="aggiungiDroga('eroina','sostanze')">eroina</span>
        <span class="chip" onclick="aggiungiDroga('lsd','sostanze')">lsd</span>
        <span class="chip" onclick="aggiungiDroga('marijuana','sostanze')">marijuana</span>
        <span class="chip" onclick="aggiungiDroga('fenicillina','sostanze')">fenicillina</span>
      </div>

      <label for="sanzione">
        Importo settimana scorsa (in euro, sconto 20% da applicare) :
      </label>
      <input type="number" id="sanzione" placeholder="Inserisci la sanzione" />

      <label for="gratuita">
        Droghe della settimana scorsa sanzionate (es: 400 marijuana, 500 ketamina):
      </label>
      <input type="text" id="gratuita" placeholder="Quantit√† e tipo (separate da virgole)" />
      <div class="chips-container">
        <span class="chip" onclick="aggiungiDroga('cocaina','gratuita')">cocaina</span>
        <span class="chip" onclick="aggiungiDroga('ketamina','gratuita')">ketamina</span>
        <span class="chip" onclick="aggiungiDroga('eroina','gratuita')">eroina</span>
        <span class="chip" onclick="aggiungiDroga('lsd','gratuita')">lsd</span>
        <span class="chip" onclick="aggiungiDroga('marijuana','gratuita')">marijuana</span>
        <span class="chip" onclick="aggiungiDroga('fenicillina','gratuita')">fenicillina</span>
      </div>

      <button onclick="aggiungiRisultato()" id="addButton">
        Aggiungi Famiglia
      </button>

      <br />

      <button onclick="eliminaDati()" id="deleteButton">Elimina Tutto</button>

      <hr />

      <h1>Inserimento veloce</h1>
      <p id="subtitle">
        NomeFamiglia : qtaDroga tipoDroga / qtaDroga2 tipoDroga2 .. |
        sanzioneDaScalare / qtaDrogaSanz tipoDrogaSanz / qtaDrogaSanz2
        tipoDrogaSanz2
      </p>

      <textarea id="inputArea" placeholder="Incolla qui il testo..."></textarea>
      <br />
      <button onclick="processInput()" id="addButton">Genera</button>

      <!-- Gestione prezzi -->
      <div id="priceManager">
        <h1 style="font-size:1.1rem; margin-bottom:10px;">Gestione prezzi sostanze</h1>
        <p class="note-prezzo">
          Modifica i prezzi per unit√† (es. ‚Ç¨/grammo). I valori vengono salvati sul tuo browser.
        </p>
        <div class="price-row">
          <label for="price-cocaina">Cocaina (‚Ç¨)</label>
          <input type="number" step="10" id="price-cocaina" />
        </div>
        <div class="price-row">
          <label for="price-ketamina">Ketamina (‚Ç¨)</label>
          <input type="number" step="10" id="price-ketamina" />
        </div>
        <div class="price-row">
          <label for="price-eroina">Eroina (‚Ç¨)</label>
          <input type="number" step="10" id="price-eroina" />
        </div>
        <div class="price-row">
          <label for="price-lsd">LSD (‚Ç¨)</label>
          <input type="number" step="10" id="price-lsd" />
        </div>
        <div class="price-row">
          <label for="price-marijuana">Marijuana (‚Ç¨)</label>
          <input type="number" step="10" id="price-marijuana" />
        </div>
        <div class="price-row">
          <label for="price-fenicillina">Fenicillina (‚Ç¨)</label>
          <input type="number" step="10" id="price-fenicillina" />
        </div>
        <button id="savePricesButton" onclick="salvaPrezziDaUI()">Salva prezzi</button>
        <div class="warning-prezzo">
          ‚ö†Ô∏è Se il prezzo di una sostanza √® 0, nei risultati vedrai un avviso "prezzo non impostato".
        </div>
      </div>

      <div id="result" style="display: none">
        <h2>Risultati</h2>

        <div id="exportButtons">
          <!-- <button onclick="exportJSON()">Esporta JSON</button>
  	<button onclick="exportCSV()">Esporta CSV</button> -->
          <button onclick="copiaReport()">Copia Report</button>
        </div>



        <div id="totale"></div>
      </div>
  </div>

  <script>
    let risultati = [];

    const sostanzeMappa = {
      cocaina: ["cocaina", "coca"],
      ketamina: ["ketamina", "keta"],
      eroina: ["eroina"],
      lsd: ["lsd", "acido", "francobolli"],
      marijuana: ["maria", "marijuana", "erba"],
      fenicillina: ["fenicillina"],
    };

    // Prezzi modificabili
    let prezziDroga = {
      cocaina: 500,
      ketamina: 380,
      eroina: 450,
      lsd: 420,
      marijuana: 400,
      fenicillina: 380,
    };

    function salvaDati() {
      localStorage.setItem("famiglieDroghe", JSON.stringify(risultati));
    }

    function caricaDati() {
      const datiSalvati = localStorage.getItem("famiglieDroghe");
      if (datiSalvati) {
        risultati = JSON.parse(datiSalvati);
        mostraRisultati();
      }
    }

    function eliminaDati() {
      if (!confirm("Sei sicuro di eliminare tutti i dati?")) return;
      localStorage.removeItem("famiglieDroghe");
      risultati = [];
      pulisciCampi();
      mostraRisultati();
    }

    function pulisciCampi() {
      document.getElementById("famiglia").value = "";
      document.getElementById("sostanze").value = "";
      document.getElementById("sanzione").value = "";
      document.getElementById("inputArea").value = "";
      document.getElementById("gratuita").value = "";
    }

    function normalizzaTipo(tipo) {
      for (const [tipoCanonico, alias] of Object.entries(sostanzeMappa)) {
        if (alias.includes(tipo.toLowerCase())) {
          return tipoCanonico;
        }
      }
      return tipo;
    }
    // Somiglianza tra parole (Levenshtein semplificato)
    function similarity(a, b) {
      a = a.toLowerCase();
      b = b.toLowerCase();
      let matches = 0;
      const len = Math.min(a.length, b.length);

      for (let i = 0; i < len; i++) {
        if (a[i] === b[i]) matches++;
      }
      return matches / Math.max(a.length, b.length);
    }

    // Restituisce il miglior suggerimento per un tipo sconosciuto
    function suggerisciDroga(tipoInserito) {
      tipoInserito = tipoInserito.toLowerCase();
      let bestMatch = null;
      let bestScore = 0;

      for (const [canonico, alias] of Object.entries(sostanzeMappa)) {
        for (const a of alias) {
          const score = similarity(tipoInserito, a);
          if (score > bestScore) {
            bestScore = score;
            bestMatch = canonico;
          }
        }
      }

      if (bestScore >= 0.45) {
        return bestMatch;
      }

      return null; // nessun suggerimento utile
    }


    function formattaNumero(num) {
      return num.toLocaleString("it-IT", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    // Gestione prezzi in localStorage
    function caricaPrezzi() {
      const salvati = localStorage.getItem("prezziDroga");
      if (salvati) {
        try {
          const parsed = JSON.parse(salvati);
          prezziDroga = { ...prezziDroga, ...parsed };
        } catch (e) {
          console.warn("Prezzi salvati corrotti, uso default.");
        }
      }
    }

    function salvaPrezzi() {
      localStorage.setItem("prezziDroga", JSON.stringify(prezziDroga));
    }

    function popolaFormPrezzi() {
      for (const tipo in prezziDroga) {
        const input = document.getElementById("price-" + tipo);
        if (input) {
          input.value = prezziDroga[tipo];
        }
      }
    }

    function salvaPrezziDaUI() {
      for (const tipo in prezziDroga) {
        const input = document.getElementById("price-" + tipo);
        if (!input) continue;
        const val = parseFloat(input.value);
        if (!isNaN(val) && val >= 0) {
          prezziDroga[tipo] = val;
        }
      }
      salvaPrezzi();
      alert("Prezzi aggiornati.");
      mostraRisultati(); // ricalcola visuale con i nuovi prezzi (per le nuove famiglie)
    }

    // Prezzo unitario basato su alias + prezziDroga
    function getPrezzoUnitario(tipo) {
      tipo = tipo.toLowerCase();
      for (const [tipoCanonico, alias] of Object.entries(sostanzeMappa)) {
        if (alias.includes(tipo)) {
          return prezziDroga[tipoCanonico] || 0;
        }
      }
      return 0;
    }

    // Aggiunta droghe cliccando i chip
    function aggiungiDroga(tipo, campoId) {
      const input = document.getElementById(campoId);
      if (!input) return;

      let val = input.value;
      if (val === "") {
        // campo vuoto ‚Üí solo tipo
        input.value = tipo;
        input.focus();
        return;
      }

      // togli solo gli spazi finali, non quelli all'inizio
      let trimmedVal = val.replace(/\s+$/g, "");

      // se dopo aver tolto gli spazi √® vuoto
      if (trimmedVal === "") {
        input.value = tipo;
        input.focus();
        return;
      }

      // ultimo segmento dopo l'ultima virgola
      const lastSegment = trimmedVal.split(",").pop().trim();
      const soloNumeroSegmentoFinale = /^\d+$/.test(lastSegment);

      if (soloNumeroSegmentoFinale) {
        // Esempio:
        // "100"                    -> "100 cocaina, "
        // "100 cocaina, 200"       -> "100 cocaina, 200 cocaina, "
        input.value = trimmedVal + " " + tipo + ", ";
      } else {
        // caso generico:
        // "cocaina"                -> "cocaina, ketamina"
        // "100 cocaina"            -> "100 cocaina, ketamina"
        if (!trimmedVal.endsWith(",")) trimmedVal += ",";
        input.value = trimmedVal + " " + tipo;
      }

      input.focus();
    }



    // Aggiunta dal form
    function aggiungiRisultato() {
      const nomeFamiglia = document.getElementById("famiglia").value.trim();
      const sostanze = document
        .getElementById("sostanze")
        .value.split(",");
      const gratuite = document
        .getElementById("gratuita")
        .value.split(",");
      const sanzione =
        parseFloat(document.getElementById("sanzione").value) || 0;

      if (!nomeFamiglia || (sostanze.length === 0 && gratuite.length === 0)) {
        alert("Per favore, completa tutti i campi correttamente!");
        return;
      }

      let totale = 0;
      let dettagli = "";

      sostanze.forEach((sostanza) => {
        if (sostanza.trim() === "") return;
        const [quantita, ...tipoParts] = sostanza.trim().split(/\s+/);
        const tipo = tipoParts.join(" ");
        const quantitaNum = parseFloat(quantita);
        if (isNaN(quantitaNum)) return;
        const tipoNormalizzato = normalizzaTipo(tipo);
        const prezzoUnitario = getPrezzoUnitario(tipoNormalizzato);
        const valore = quantitaNum * prezzoUnitario;
        totale += valore;
        if (prezzoUnitario === 0) {
          const suggerimento = suggerisciDroga(tipoNormalizzato);
          if (suggerimento) {
            dettagli += `‚Ä¢ ${quantitaNum} ${tipoNormalizzato} (‚ö†Ô∏è prezzo non impostato ‚Äì forse intendevi: <strong>${suggerimento}</strong>)<br>`;
          } else {
            dettagli += `‚Ä¢ ${quantitaNum} ${tipoNormalizzato} (‚ö†Ô∏è prezzo non impostato ‚Äì nessun suggerimento)<br>`;
          }
        } else {
          dettagli += `‚Ä¢ ${quantitaNum} ${tipoNormalizzato} (${formattaNumero(
            valore
          )}‚Ç¨)<br>`;
        }
      });

      if (gratuite.some((g) => g.trim() !== "")) {
        dettagli += `<br><strong>Droghe sanzione :</strong><br>`;
        gratuite.forEach((sostanza) => {
          if (sostanza.trim() === "") return;
          const [quantita, ...tipoParts] = sostanza.trim().split(/\s+/);
          const tipo = tipoParts.join(" ");
          const quantitaNum = parseFloat(quantita);
          if (isNaN(quantitaNum)) return;
          const tipoNormalizzato = normalizzaTipo(tipo);
          dettagli += `‚Ä¢ ${quantitaNum} ${tipoNormalizzato} (GRATIS)<br>`;
        });
      }

      const sanzioneRidotta = sanzione * 0.8;
      const totaleNetto = totale - sanzioneRidotta;

      risultati.push({
        famiglia: nomeFamiglia,
        totale: totale,
        dettagli: dettagli,
        sanzione: sanzione,
        totaleNetto: totaleNetto,
      });

      salvaDati();
      pulisciCampi();
      mostraRisultati();
    }

    function mostraRisultati() {
      const container = document.getElementById("result");
      const target = document.getElementById("totale");
      if (!risultati.length) {
        container.style.display = "block";
        target.innerHTML = "<em>Nessun risultato ancora. Aggiungi una famiglia.</em>";
        return;
      }

      target.innerHTML = "Caricamento...";
      container.style.display = "block";

      // Ordina per totale netto
      risultati.sort((a, b) => b.totaleNetto - a.totaleNetto);

      let resultText = "";

      risultati.forEach((fam) => {
        if (fam) {
          const intestazione =
            fam.totaleNetto >= 0
              ? `${fam.famiglia} ‚Äì ${formattaNumero(fam.totaleNetto)}‚Ç¨`
              : `${fam.famiglia} ‚Äì üîª Da prelevare: ${formattaNumero(
                Math.abs(fam.totaleNetto)
              )}‚Ç¨`;

          let sanzioneText = "";
          if (fam.sanzione > 0) {
            sanzioneText = `<div class="sanzione">üí∏ Sanzione : ${formattaNumero(
              fam.sanzione * 0.8
            )}‚Ç¨</div>`;
          }

          resultText += `
  <div class="famiglia">${intestazione}</div>
  <div class="dettagli">${fam.dettagli}</div>
  ${sanzioneText}
  <div class="totale-netto">
    ${fam.totaleNetto >= 0
              ? `‚û°Ô∏è Totale netto: ${formattaNumero(fam.totaleNetto)}‚Ç¨`
              : `üîª Da prelevare: ${formattaNumero(Math.abs(fam.totaleNetto))}‚Ç¨`
            }
  </div>

  <button onclick="modificaFamiglia(${risultati.indexOf(fam)})" style="background:#f59e0b;color:white;margin-right:5px;">Modifica</button>
  <button onclick="eliminaFamiglia(${risultati.indexOf(fam)})" style="background:#ef4444;color:white;">Elimina</button>

  <br><br>
`;

        }
      });

      target.innerHTML = resultText;
    }

    // Parsing da textarea "inserimento veloce"
    function processInput() {
      const inputText = document.getElementById("inputArea").value.trim();
      if (!inputText) {
        alert("Per favore, completa il campo correttamente!");
        return;
      }

      const families = parseFamilies(inputText);

      families.forEach((fam) => {
        risultati.push({
          famiglia: fam.intestazione,
          totale: fam.totale,
          dettagli: fam.dettagli,
          sanzione: fam.sanzione,
          totaleNetto: fam.totaleNetto,
        });
      });

      salvaDati();
      mostraRisultati();
    }

    function parseFamilies(input) {
      return input
        .split("\n")
        .filter(Boolean)
        .map((line) => {
          const [familyName, drugsString] = line
            .split(":")
            .map((str) => str.trim());

          if (!familyName || !drugsString) return null;

          const [paidDrugsPart, sanctionAndSanctionDrugsPart] = drugsString
            .split("|")
            .map((str) => str.trim());

          const paidDrugs = paidDrugsPart.split("/").map((drugEntry) => {
            const parts = drugEntry.trim().split(" ");
            const quantity = Number(parts[0]);
            const tipoDroga = parts.slice(1).join(" ");
            const tipoNormalizzato = normalizzaTipo(tipoDroga);
            const prezzoUnitario = getPrezzoUnitario(tipoNormalizzato);
            const valoreTotale = quantity * prezzoUnitario;

            return {
              quantity,
              tipoDroga: tipoNormalizzato,
              valoreTotale,
              prezzoUnitario,
            };
          });

          let sanction = 0;
          let sanctionDrugs = [];

          if (sanctionAndSanctionDrugsPart) {
            const sanctionParts = sanctionAndSanctionDrugsPart
              .split("/")
              .map((str) => str.trim());

            if (sanctionParts.length > 0) {
              sanction = parseFloat(sanctionParts[0]) || 0;

              sanctionDrugs = sanctionParts.slice(1).map((drugEntry) => {
                const parts = drugEntry.trim().split(" ");
                const quantity = Number(parts[0]);
                const tipoDroga = parts.slice(1).join(" ");
                const tipoNormalizzato = normalizzaTipo(tipoDroga);

                return {
                  quantity,
                  tipoDroga: tipoNormalizzato,
                };
              });
            }
          }

          const dettagliVendita = paidDrugs
            .map((d) =>
              d.prezzoUnitario === 0
                ? (() => {
                  const sug = suggerisciDroga(d.tipoDroga);
                  if (sug) {
                    return `‚Ä¢ ${d.quantity} ${d.tipoDroga} (‚ö†Ô∏è prezzo non impostato ‚Äì forse intendevi: ${sug})`;
                  }
                  return `‚Ä¢ ${d.quantity} ${d.tipoDroga} (‚ö†Ô∏è prezzo non impostato ‚Äì nessun suggerimento)`;
                })()
                : `‚Ä¢ ${d.quantity} ${d.tipoDroga} (${formattaNumero(
                  d.valoreTotale
                )}‚Ç¨)`
            )
            .join("<br>");

          const dettagliSanzione =
            sanctionDrugs.length > 0
              ? `<br><strong>Droghe sanzione :</strong><br>` +
              sanctionDrugs
                .map(
                  (d) =>
                    `‚Ä¢ ${d.quantity} ${d.tipoDroga} (GRATIS)`
                )
                .join("<br>")
              : "";

          const totalePagato = paidDrugs.reduce(
            (acc, d) => acc + d.valoreTotale,
            0
          );

          return {
            intestazione: familyName,
            dettagli: dettagliVendita + dettagliSanzione,
            totale: totalePagato,
            sanzione: sanction,
            totaleNetto: totalePagato - sanction * 0.8,
          };
        })
        .filter(Boolean);
    }

    // Export
    function downloadFile(filename, content, mime) {
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }


    /*
      function exportJSON() {
        if (!risultati.length) {
          alert("Nessun dato da esportare.");
          return;
        }
        downloadFile(
          "report_sostanze.json",
          JSON.stringify(risultati, null, 2),
          "application/json"
        );
      }

      function exportCSV() {
        if (!risultati.length) {
          alert("Nessun dato da esportare.");
          return;
        }
        const header = ["famiglia", "totale", "sanzione", "totaleNetto"];
        const rows = risultati.map((r) => [
          r.famiglia,
          r.totale,
          r.sanzione,
          r.totaleNetto,
        ]);
        const csv = [header.join(";")]
          .concat(
            rows.map((row) =>
              row
                .map((v) => `"${String(v).replace(/"/g, '""')}"`)
                .join(";")
            )
          )
          .join("\n");
        downloadFile("report_sostanze.csv", csv, "text/csv");
      }
      */

    // ====== COPIA REPORT ======
    function copiaReport() {
      if (!risultati.length) {
        alert("Nessun dato da copiare.");
        return;
      }

      let testo = "PAGAMENTI MAFIE/GANG\n\n";

      risultati.forEach((fam) => {

        // Titolo famiglia
        if (fam.totaleNetto >= 0) {
          testo += `${fam.famiglia} ‚Äì ${formattaNumero(fam.totaleNetto)}‚Ç¨\n`;
        } else {
          testo += `${fam.famiglia} ‚Äì üîª Da prelevare: ${formattaNumero(Math.abs(fam.totaleNetto))}‚Ç¨\n`;
        }

        // Dettagli puliti
        let dettagli = fam.dettagli
          .replace(/<br>/g, "\n")
          .replace(/<[^>]*>/g, "")
          .trim(); // ‚Üê elimina spazi e righe vuote finali

        // Rimuove eventuali righe vuote doppie
        dettagli = dettagli.replace(/\n{2,}/g, "\n");

        testo += dettagli + "\n";

        // Sanzione (attaccata ai dettagli, NO SPAZI)
        if (fam.sanzione > 0) {
          testo += `üí∏ Sanzione : ${formattaNumero(fam.sanzione * 0.8)}‚Ç¨\n`;
        }

        // Totale netto subito sotto, NESSUNA RIGA VUOTA PRIMA
        if (fam.totaleNetto >= 0) {
          testo += `‚û°Ô∏è Totale netto: ${formattaNumero(fam.totaleNetto)}‚Ç¨\n`;
        } else {
          testo += `üîª Da prelevare: ${formattaNumero(Math.abs(fam.totaleNetto))}‚Ç¨\n`;
        }

        // Riga vuota SOLO tra famiglie
        testo += `\n`;
      });

      navigator.clipboard.writeText(testo).then(() => {
        alert("Report copiato negli appunti.");
      });
    }



    // ====== ELIMINA / MODIFICA SINGOLA FAMIGLIA ======
    function eliminaFamiglia(index) {
      if (!confirm("Eliminare questa famiglia?")) return;
      risultati.splice(index, 1);
      salvaDati();
      mostraRisultati();
    }

    function modificaFamiglia(index) {
      const fam = risultati[index];

      // Rimetti nel form i dati originali
      document.getElementById("famiglia").value = fam.famiglia;
      document.getElementById("sostanze").value = estraiSostanzeDaDettagli(fam.dettagli, false);
      document.getElementById("gratuita").value = estraiSostanzeDaDettagli(fam.dettagli, true);
      document.getElementById("sanzione").value = fam.sanzione;

      // Rimuovi temporaneamente la famiglia dalla lista
      risultati.splice(index, 1);
      salvaDati();
      mostraRisultati();
    }

    // Estrae sostanze normali o gratuite dal dettaglio HTML
    function estraiSostanzeDaDettagli(dettagli, gratuite = false) {
      const lines = dettagli.replace(/<br>/g, "\n").split("\n").map(s => s.trim());
      let output = [];

      let inGratis = false;

      for (let line of lines) {
        if (line.toLowerCase().includes("droghe sanzione")) {
          inGratis = true;
          continue;
        }

        if (!line.startsWith("‚Ä¢")) continue;
        if (inGratis !== gratuite) continue;

        const cleaned = line
          .replace("‚Ä¢", "")
          .replace("(GRATIS)", "")
          .replace("(‚ö†Ô∏è prezzo non impostato)", "")
          .replace(/\(.*?\)/, "")
          .trim();

        if (cleaned) output.push(cleaned);
      }

      return output.join(", ");
    }


    window.onload = function () {
      caricaPrezzi();
      popolaFormPrezzi();
      caricaDati();
    };
  </script>
</body>

</html>